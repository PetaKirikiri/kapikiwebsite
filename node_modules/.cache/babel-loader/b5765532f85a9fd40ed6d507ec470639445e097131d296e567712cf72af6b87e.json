{"ast":null,"code":"import { auth } from \"../firebase\";\nconst SENDER_EMAIL = \"peta@kapiki.co.nz\";\nasync function getServiceAccountCredentials() {\n  try {\n    const response = await fetch(\"/emailtoken.json\");\n    if (!response.ok) {\n      throw new Error(`Failed to load service account credentials: HTTP ${response.status}`);\n    }\n    const contentType = response.headers.get(\"content-type\");\n    if (!contentType || !contentType.includes(\"application/json\")) {\n      throw new Error(\"Response was not JSON. Make sure emailtoken.json is in the public directory.\");\n    }\n    const data = await response.json();\n    if (!data.private_key || !data.client_email || !data.private_key_id) {\n      throw new Error(\"Invalid service account credentials format\");\n    }\n    return data;\n  } catch (error) {\n    console.error(\"Error loading service account credentials:\", error);\n    throw new Error(`Failed to load service account credentials: ${error.message}`);\n  }\n}\nasync function createJWT() {\n  const credentials = await getServiceAccountCredentials();\n  const header = {\n    alg: \"RS256\",\n    typ: \"JWT\",\n    kid: credentials.private_key_id\n  };\n  const now = Math.floor(Date.now() / 1000);\n  const payload = {\n    iss: credentials.client_email,\n    scope: \"https://www.googleapis.com/auth/gmail.send\",\n    aud: \"https://oauth2.googleapis.com/token\",\n    exp: now + 3600,\n    iat: now\n  };\n  const encodedHeader = btoa(JSON.stringify(header)).replace(/\\+/g, \"-\").replace(/\\//g, \"_\").replace(/=+$/, \"\");\n  const encodedPayload = btoa(JSON.stringify(payload)).replace(/\\+/g, \"-\").replace(/\\//g, \"_\").replace(/=+$/, \"\");\n  const privateKeyBuffer = pemToArrayBuffer(credentials.private_key);\n  const key = await crypto.subtle.importKey(\"pkcs8\", privateKeyBuffer, {\n    name: \"RSASSA-PKCS1-v1_5\",\n    hash: {\n      name: \"SHA-256\"\n    }\n  }, false, [\"sign\"]);\n  const signature = await crypto.subtle.sign({\n    name: \"RSASSA-PKCS1-v1_5\",\n    hash: {\n      name: \"SHA-256\"\n    }\n  }, key, new TextEncoder().encode(`${encodedHeader}.${encodedPayload}`));\n  const encodedSignature = btoa(String.fromCharCode(...new Uint8Array(signature))).replace(/\\+/g, \"-\").replace(/\\//g, \"_\").replace(/=+$/, \"\");\n  return `${encodedHeader}.${encodedPayload}.${encodedSignature}`;\n}\nfunction pemToArrayBuffer(pem) {\n  const base64 = pem.replace(\"-----BEGIN PRIVATE KEY-----\", \"\").replace(\"-----END PRIVATE KEY-----\", \"\").replace(/\\n/g, \"\");\n  const binaryString = atob(base64);\n  const bytes = new Uint8Array(binaryString.length);\n  for (let i = 0; i < binaryString.length; i++) {\n    bytes[i] = binaryString.charCodeAt(i);\n  }\n  return bytes.buffer;\n}\nfunction createMessage(to, bcc, subject, messageText) {\n  const str = [\"From: \" + SENDER_EMAIL, \"To: \" + to, \"Bcc: \" + bcc.join(\",\"), \"Subject: \" + subject, \"\", messageText].join(\"\\n\");\n  const encodedMessage = btoa(str).replace(/\\+/g, \"-\").replace(/\\//g, \"_\").replace(/=+$/, \"\");\n  return encodedMessage;\n}\nexport async function sendEmail(recipientEmails, subject, messageText) {\n  try {\n    const response = await fetch(\"/api/send-email\", {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\"\n      },\n      body: JSON.stringify({\n        to: SENDER_EMAIL,\n        bcc: recipientEmails,\n        subject,\n        message: messageText\n      })\n    });\n    if (!response.ok) {\n      const error = await response.json();\n      throw new Error(error.message || \"Failed to send email\");\n    }\n    return await response.json();\n  } catch (error) {\n    console.error(\"Error sending email:\", error);\n    throw new Error(\"Failed to send email. Please try again later.\");\n  }\n}","map":{"version":3,"names":["auth","SENDER_EMAIL","getServiceAccountCredentials","response","fetch","ok","Error","status","contentType","headers","get","includes","data","json","private_key","client_email","private_key_id","error","console","message","createJWT","credentials","header","alg","typ","kid","now","Math","floor","Date","payload","iss","scope","aud","exp","iat","encodedHeader","btoa","JSON","stringify","replace","encodedPayload","privateKeyBuffer","pemToArrayBuffer","key","crypto","subtle","importKey","name","hash","signature","sign","TextEncoder","encode","encodedSignature","String","fromCharCode","Uint8Array","pem","base64","binaryString","atob","bytes","length","i","charCodeAt","buffer","createMessage","to","bcc","subject","messageText","str","join","encodedMessage","sendEmail","recipientEmails","method","body"],"sources":["/Users/petakirikiri/Coding/Ka Piki/src/services/emailService.js"],"sourcesContent":["import { auth } from \"../firebase\";\n\nconst SENDER_EMAIL = \"peta@kapiki.co.nz\";\n\nasync function getServiceAccountCredentials() {\n  try {\n    const response = await fetch(\"/emailtoken.json\");\n    if (!response.ok) {\n      throw new Error(\n        `Failed to load service account credentials: HTTP ${response.status}`\n      );\n    }\n    const contentType = response.headers.get(\"content-type\");\n    if (!contentType || !contentType.includes(\"application/json\")) {\n      throw new Error(\n        \"Response was not JSON. Make sure emailtoken.json is in the public directory.\"\n      );\n    }\n    const data = await response.json();\n    if (!data.private_key || !data.client_email || !data.private_key_id) {\n      throw new Error(\"Invalid service account credentials format\");\n    }\n    return data;\n  } catch (error) {\n    console.error(\"Error loading service account credentials:\", error);\n    throw new Error(\n      `Failed to load service account credentials: ${error.message}`\n    );\n  }\n}\n\nasync function createJWT() {\n  const credentials = await getServiceAccountCredentials();\n\n  const header = {\n    alg: \"RS256\",\n    typ: \"JWT\",\n    kid: credentials.private_key_id,\n  };\n\n  const now = Math.floor(Date.now() / 1000);\n  const payload = {\n    iss: credentials.client_email,\n    scope: \"https://www.googleapis.com/auth/gmail.send\",\n    aud: \"https://oauth2.googleapis.com/token\",\n    exp: now + 3600,\n    iat: now,\n  };\n\n  const encodedHeader = btoa(JSON.stringify(header))\n    .replace(/\\+/g, \"-\")\n    .replace(/\\//g, \"_\")\n    .replace(/=+$/, \"\");\n  const encodedPayload = btoa(JSON.stringify(payload))\n    .replace(/\\+/g, \"-\")\n    .replace(/\\//g, \"_\")\n    .replace(/=+$/, \"\");\n\n  const privateKeyBuffer = pemToArrayBuffer(credentials.private_key);\n  const key = await crypto.subtle.importKey(\n    \"pkcs8\",\n    privateKeyBuffer,\n    { name: \"RSASSA-PKCS1-v1_5\", hash: { name: \"SHA-256\" } },\n    false,\n    [\"sign\"]\n  );\n\n  const signature = await crypto.subtle.sign(\n    { name: \"RSASSA-PKCS1-v1_5\", hash: { name: \"SHA-256\" } },\n    key,\n    new TextEncoder().encode(`${encodedHeader}.${encodedPayload}`)\n  );\n\n  const encodedSignature = btoa(\n    String.fromCharCode(...new Uint8Array(signature))\n  )\n    .replace(/\\+/g, \"-\")\n    .replace(/\\//g, \"_\")\n    .replace(/=+$/, \"\");\n\n  return `${encodedHeader}.${encodedPayload}.${encodedSignature}`;\n}\n\nfunction pemToArrayBuffer(pem) {\n  const base64 = pem\n    .replace(\"-----BEGIN PRIVATE KEY-----\", \"\")\n    .replace(\"-----END PRIVATE KEY-----\", \"\")\n    .replace(/\\n/g, \"\");\n  const binaryString = atob(base64);\n  const bytes = new Uint8Array(binaryString.length);\n  for (let i = 0; i < binaryString.length; i++) {\n    bytes[i] = binaryString.charCodeAt(i);\n  }\n  return bytes.buffer;\n}\n\nfunction createMessage(to, bcc, subject, messageText) {\n  const str = [\n    \"From: \" + SENDER_EMAIL,\n    \"To: \" + to,\n    \"Bcc: \" + bcc.join(\",\"),\n    \"Subject: \" + subject,\n    \"\",\n    messageText,\n  ].join(\"\\n\");\n\n  const encodedMessage = btoa(str)\n    .replace(/\\+/g, \"-\")\n    .replace(/\\//g, \"_\")\n    .replace(/=+$/, \"\");\n\n  return encodedMessage;\n}\n\nexport async function sendEmail(recipientEmails, subject, messageText) {\n  try {\n    const response = await fetch(\"/api/send-email\", {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        to: SENDER_EMAIL,\n        bcc: recipientEmails,\n        subject,\n        message: messageText,\n      }),\n    });\n\n    if (!response.ok) {\n      const error = await response.json();\n      throw new Error(error.message || \"Failed to send email\");\n    }\n\n    return await response.json();\n  } catch (error) {\n    console.error(\"Error sending email:\", error);\n    throw new Error(\"Failed to send email. Please try again later.\");\n  }\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}